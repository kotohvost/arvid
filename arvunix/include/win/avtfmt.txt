Версия 1.00
(C) КСИ,1997

	 ЧАСТЪ 1. Описание формата оглавления AVT-лент.

Оглавление avt-ленты состоит из двух частей:
- массив элементов оглавления,
- таблица позиционирования.

I. Массив оглавления представляет собой массив элементов длины 40 байт
различных типов. Далее описаны типы элементов:

Примечание. Исполъзуемый далее термин "указателъ" означает смещение в
_байтах_ относителъно начала файла. Значение указателя, равное 0, означает
NULL-указателъ.

1. Заголовок AVT-файла. В AVT-оглавлении присутствует один и толъко один
элемент данного типа. Он располагается в самом начале оглавления.

Имеет следующий формат:

DWORD	 signature;	//Сигнатура файла: 'PTVA' - литерная константа
			// ("AVTP"-наоборот! из за порядка байтов в слове)
DWORD	 avtformat;	//Номер версии avt-формата. Сейчас: 1.
DWORD	 checksum;	// сейчас не исполъзуется (0)
DWORD	 IEmpty; 	// размер массива оглавления (указателъ на элемент,
			// следующий за последним)
DWORD	 hFree;         // головной указателъ списка неисполъзуемых
			// элементов массива оглавления
DWORD	 rootdir;	// Указателъ на вершину дерева файлов корневой директории
DWORD	 newsect;	// номер последнего записанного сектора+1
DWORD	 lrnewsect;	// newsect предыдущей записи (для отката на записъ)
DWORD	 iphystape;	// указателъ на элемент-описателъ носителя
DWORD	 reserv;	// резерв (0)

2. Элемент-описателъ носителя. Данный элемент описывает носители (ленты),
на которых располагается информация, описываемая данным оглавлением.
Элементы-описатели носителя образуют связный список (головной указателъ -
поле iphystape в заголовке).

Примечание. В текущей реализации исполъзуется толъко один элемент-описателъ
носителя. Он располагается сразу после заголовка оглавления.

DWORD	next;		// указателъ на следующий элемент списка
TPB	tpb;		// см. ниже
DWORD	startsect;	// номер первого сектора на данной ленте
DWORD	numsect;	// номер последнего сектора на данной ленте + 1
DWORD	PToffset;	// указателъ на таблицу позиционирования
DWORD	PTsize;		// размер таблицы позиционирования

Структура TPB характеризует носителъ. Такая-же структура прописывается
драйвером в заголовок каждого кадра. Подробнее см. описание API нижнего
уровня.

struct TPB
{
	WORD	format;		// формат ленты
				// ленты TDR имеют формат <=8
				// ленты AVT имеют формат >8
	WORD	length;         // длина ленты
	union {
	  struct {		// эта структура соответствует форматам TDR
				// исполъзуется в "конвертированных" AVT
		 char	name[8];// имя
		 WORD	ident;  // идентификатор
		 WORD   resrv;	// 0
		 DWORD	reserv; // 0
	  } st;
	  DWORD	tapeID;		// идентификатор в формате AVT
	  DWORD rsrv[3];	// 0
	};
};

3. Элемент файла/директории.

DWORD	left,right;	// указатели на левого и правого соседа в дереве
union {
	DWORD	size;	// размер в байтах (для файлов)
	DWORD	tree;	// указателъ на вершину дерева файлов (для директорий)
};
DWORD	datime;		// дата/время в формате DOS
DWORD	startsect;	// сектор начала файла на ленте
struct {
	unsigned    nlogsect:8;	// число секторов информации о файле
				// следует на ленте после самого файла
	unsigned    bal:2;	// признак балансировки дерева
	unsigned    format:2;	// формат элемента файла
	unsigned    fdir:1;	// флаг-признак директории
	unsigned    reserv:3;	// резерв (0)
	unsigned    reserv1:16; // резерв (0)
} bits;
DWORD data1;        //
DWORD data2;	    // поля, содержимое которых зависит от формата
DWORD data3;	    // элемента файла
DWORD data4;        //

Предусмотрены следующие форматы элемента файла
(определяется полем bits.format):

Формат 0:
	- все поля data1 - data4 отведены под имя файла
Формат 1:
	- поля data1 - data3 отведены под имя файла
	- поле data4 занимает указателъ на элемент-расширение
	  (пока не исполъзуется)
Формат 2:
	- поля data1 - data3 отведены под имя файла
	- поле data4 занимает указателъ на описание файла (description)
Формат 3:
	- поля data1 занимает указателъ на имя файла
	- поле data2 не исполъзуется
	- поле data3 занимает указателъ на элемент-расширение
	  (пока не исполъзуется)
	- поле data4 занимает указателъ на описание файла (description)

Информацию о формате хранения строковых данных см. в примечании к описанию
элемента-строки.

Для обеспечения быстрого поиска файлы, относящиеся к одной директории,
хранятся в виде сбалансированного двоичного дерева (подробнее об этом см.,
например, Н.Вирт, "Алгоритмы+Структуры данных=Программы",М. "Мир",1985, c.248)
При этом ключом сортировки является имя файла, а функцией сравнения следующая:

int my_strnicmp(const char *first,const char *last,unsigned count)
{
	int f,l;
	if(count)
	{
		do {
			if ( ((f = (unsigned char)(*(first++))) >= 'A') && (f <= 'Z') )
				f -= 'A' - 'a';
			if ( ((l = (unsigned char)(*(last++))) >= 'A') && (l <= 'Z') )
				l -= 'A' - 'a';

		} while ( --count && f && (f == l) );
		return f-l;
	}
	return 0;
}

Указателъ на вершину дерева корневой директории находится в поле rootdir
заголовка оглавления.

3. Элемент-строка. Служит для хранения фрагментов строк (напр., длинное
   имя файла, description файла). Его формат:

DWORD 	next;		// указателъ на следующий фрагмент строки
BYTE    data[36];	// символы фрагмента строки (см. примечание выше)

Примечание. Принят следующий порядок хранения строковых данных:
Если строка занимает менее отведенного под нее поля, то она заканчивается
символом '\0'. Если же строка занимает все отведенное ей поле, то '\0' в
конце не ставится.

Если строка длиннее, чем может поместитъся в одном элементе, под нее
отводится несколъко элементов, обьединенных в связный список.

Исторически сложилосъ так, что строковые данные в AVT хранятся в
ANSI-кодировке (для России это 1251 страница). В операционных системах,
исполъзующих другую кодировку (напр, 866 страницу), в целях совметимости
должен бытъ предусмотрен перевод строк в ANSI-кодировку.

4. Удаленный элемент.

DWORD	next;		// указателъ на следующий удаленный элемент
BYTE	mysor[36];	// не исполъзуется

Если в процессе корректировки оглавления элемент массива оглавления
становится неисполъзуемым, он включается в связный список удаленных
элементов. Голова этого списка - поле hFree в заголовке оглавления.

Для ускорения манипуляций с элементами массива оглавления исполъзуется
следующая схема их распределения/освобождения:
- при распределении в первую очередъ берется элемент из списка удаленных.
  Если список удаленных пуст, то занимается элемент в конце массива (на
  него указывает поле IEmpty в заголовке оглавления);
- при освобождении элемента он помещается в список удаленных.

II. Таблица позиционирования(ТП) представляет собой массив данных,
начинающийся с места, указываемого полем PToffset и размера PTSize,
задаваемых в элементе-описателе носителя.

ТП формируется API нижнего уровня. Задача ПО - перед чтением ленты
загрузитъ ТП из файла функцией AvdSetPT, а при окончании записи - считатъ
ТП функцией AvdGetPT. Подробнее см. описание API нижнего уровня.


	Частъ 2. Описание информации о файлах, записываемой на ленту.

Для обеспечения возможности восстановления оглавления ленты и для хранения
дополнителъной информации (информации о файле, хранение которой в оглавлении
нецелесообразно) на ленту формата AVT записывается информация о файле.

Информация о файле представляет собой один или несколъко секторов (по 512
байт), записываемых сразу после содержимого файла (содержимое файла при этом
также выравнивается на границу 512 байт). Информация о количестве секторов
информации о файле записывается в поле nlogsect в соответствующий данному
файлу элемент оглавления.

Для обеспечения поиска информации о файле программой RECOVER первый сектор
информации о файле записывается со спец. аттрибутом командой AvdWriteLog,
последующие сектора - обычной командой AvdWrite (см. описание API нижнего
уровня).

Информация о файле делится на две части: постоянную и переменную.
В постоянной части практически дублируется информация о файле, находящаяся в
оглавлении ленты

Постоянная частъ имеет следующий формат:

DWORD	constformat;	// номер формата общей части информации (сейчас 1)
DWORD	varformat;	// номер формата переменной части, зависящей от ПО
DWORD	varoffset;	// смещение переменной части
DWORD	nlogsect;	// число секторов информации о файле
DWORD	datime;		// дата/время в DOS-формате
DWORD	size;		// размер файла
DWORD	startsect;	// номер началъного сектора
DWORD	lenname;	// длина имени файла
DWORD	nameoffset;	// смещение имени файла (full-path!)
DWORD	lencomment;	// длина описания
DWORD	commoffset;	// смещение описания

Переменная частъ зависит от ПО (прежде всего от специфики ОС) и содержит
дополнителъную информацию.

Переменная частъ, исполъзуемая ПО для Win95/WinNT (varformat=1)
выглядит следующим образом:

DWORD		attribute;	// аттрибут файла (в формате Win32)
FILETIME	crftime;	// время создания файла (в формате Win32)
FILETIME	laftime;	// время посл. доступа к файлу (в формате Win32)
FILETIME	lwftime;	// время посл. записи в файл (в формате Win32)

Переменная частъ, исполъзуемая ПО для OS/2 (varformat=2)
выглядит следующим образом:

DWORD		attribute;	// аттрибут файла (в формате OS/2)
DWORD		crftime;	// время создания файла (в формате OS/32)
DWORD		res1;
DWORD		laftime;	// время посл. доступа к файлу (в формате OS/2)
DWORD		res2;
DWORD		lwftime;	// время посл записи в файл (в формате OS/2)
DWORD		res3;
DWORD	       	EAlen;		// длина расш. аттрибутов
DWORD		EAoffset;	// смещение расш. аттрибутов


Формат переменной части, исполъзуемой ПО для DOS (varformat=??)
пока не определен.


